CREATE OR REPLACE PACKAGE DU_Migrator
AS
	PROCEDURE MigrateNicknames ;
END DU_Migrator ;
/
show error ;

CREATE OR REPLACE PACKAGE BODY DU_Migrator
AS
	PROCEDURE MigrateNicknames
	IS
		CURSOR MIGRATE_NICKNAME_CURSOR IS SELECT * FROM NICKNAME@DU_RANGER ;
		CURSOR MIGRATE_CUSTOM_NICKNAME_CURSOR IS SELECT * FROM CUSTOM_NICKNAME@DU_RANGER ;

		MIGRATENICKNAMECURSOR MIGRATE_NICKNAME_CURSOR%ROWTYPE;
		MIGRATECUSTOMNICKNAMECURSOR MIGRATE_CUSTOM_NICKNAME_CURSOR%ROWTYPE;
	BEGIN
		DELETE LIST_DETAILS WHERE LIST_CONFIG_ID > 1024 ;
		DELETE LIST_CONFIGS_NETWORKS WHERE LIST_CONFIG_ID > 1024 ;
		DELETE LIST_CONFIGS_RULES WHERE LIST_CONFIG_ID > 1024 ;
		DELETE LIST_CONFIGS WHERE ID > 1024 ;

		DELETE CUSTOM_NICKNAME_VALUES ;
		DELETE CUSTOM_NICKNAMES ;

		OPEN MIGRATE_NICKNAME_CURSOR ;
		LOOP
			FETCH MIGRATE_NICKNAME_CURSOR INTO MIGRATENICKNAMECURSOR ;
			EXIT WHEN MIGRATE_NICKNAME_CURSOR%NOTFOUND ;

			INSERT INTO LIST_CONFIGS (ID, NAME, LIST_TYPE, DATA_TYPE, DESCRIPTION, FIELD_CATEGORY_ID, CATEGORY)
				VALUES (LIST_CONFIGS_SEQ.NEXTVAL, MIGRATENICKNAMECURSOR.NAME, 1, 3, MIGRATENICKNAMECURSOR.DESCRIPTION, 2, '') ;

			INSERT INTO LIST_CONFIGS_NETWORKS (NETWORK_ID, LIST_CONFIG_ID) VALUES (999, LIST_CONFIGS_SEQ.CURRVAL) ;

			INSERT INTO LIST_DETAILS (ID, LIST_CONFIG_ID, VALUE, VALUE_TYPE)
				SELECT LIST_DETAILS_SEQ.NEXTVAL, LIST_CONFIGS_SEQ.CURRVAL, NNP.PHONE_NUMBER, 0
					FROM NICKNAME_PHONE_NUMBER@DU_RANGER NNP
					WHERE MIGRATENICKNAMECURSOR.ID = NNP.NICKNAME_ID ;
		END LOOP ;
		CLOSE MIGRATE_NICKNAME_CURSOR ;

		OPEN MIGRATE_CUSTOM_NICKNAME_CURSOR ;
		LOOP
			FETCH MIGRATE_CUSTOM_NICKNAME_CURSOR INTO MIGRATECUSTOMNICKNAMECURSOR ;
			EXIT WHEN MIGRATE_CUSTOM_NICKNAME_CURSOR%NOTFOUND ;

			INSERT INTO CUSTOM_NICKNAMES (ID, NICKNAME, MAX_VALUES, NICKNAME_TYPE, NO_OF_DAYS, FIELD_CATEGORY_ID, NETWORK_ID)
				VALUES (CUSTOM_NICKNAMES_SEQ.NEXTVAL, MIGRATECUSTOMNICKNAMECURSOR.NICKNAME, MIGRATECUSTOMNICKNAMECURSOR.MAX_PHONE_NUMBER,
						MIGRATECUSTOMNICKNAMECURSOR.NICKNAME_TYPE, MIGRATECUSTOMNICKNAMECURSOR.NO_OF_DAYS, 2, MIGRATECUSTOMNICKNAMECURSOR.NETWORK_ID) ;

			INSERT INTO CUSTOM_NICKNAME_VALUES (ID, CUSTOM_NICKNAME_ID, VALUE, MODIFICATION_DATE, FLAG)
				SELECT CUSTOM_NICKNAME_VALUES_SEQ.NEXTVAL, CUSTOM_NICKNAMES_SEQ.CURRVAL, CNP.PHONE_NUMBER, CNP.MODIFICATION_DATE, CNP.FLAG
					FROM CUSTOM_NICKNAME_PHONE_NUMBERS@DU_RANGER CNP
					WHERE CNP.NICKNAME = MIGRATECUSTOMNICKNAMECURSOR.NICKNAME ;

			INSERT INTO LIST_CONFIGS (ID, NAME, LIST_TYPE, DATA_TYPE, DESCRIPTION, FIELD_CATEGORY_ID, CATEGORY)
				VALUES (LIST_CONFIGS_SEQ.NEXTVAL, MIGRATECUSTOMNICKNAMECURSOR.NICKNAME, 0, 3, '', 2, '') ;

			INSERT INTO LIST_CONFIGS_NETWORKS (NETWORK_ID, LIST_CONFIG_ID) VALUES (999, LIST_CONFIGS_SEQ.CURRVAL) ;

			INSERT INTO LIST_DETAILS (ID, LIST_CONFIG_ID, VALUE, VALUE_TYPE)
				VALUES (LIST_DETAILS_SEQ.NEXTVAL, LIST_CONFIGS_SEQ.CURRVAL,
						'SELECT value FROM custom_nickname_values WHERE custom_nickname_id = ' || CUSTOM_NICKNAMES_SEQ.CURRVAL, 2) ;
		END LOOP ;
		CLOSE MIGRATE_CUSTOM_NICKNAME_CURSOR ;
	END MigrateNicknames ;
END DU_Migrator ;
/
show error ;

exec DU_Migrator.MigrateNicknames ;

COMMIT;
EXIT;
