SET FEEDBACK OFF ;

SPOOL ranger-sp-db.log ;

DROP SEQUENCE SP_BLOCKS_SEQ ;
DROP SEQUENCE SP_CONNECTIONS_SEQ ;

DROP TABLE SP_BLOCKS CASCADE CONSTRAINTS ;
DROP TABLE SP_CONNECTIONS CASCADE CONSTRAINTS ;

DROP TABLE SMART_PATTERN_ALERT_DATA;
DROP TABLE SMART_PATTERN_BLOCK_RECORDS;

CREATE TABLE SP_BLOCKS (
	ID			NUMBER(20) NOT NULL,
	TEMPLATE_ID	NUMBER(20) NOT NULL,
	RULE_NAME	VARCHAR2(256) NOT NULL,
	RULE_ID		NUMBER(20) NOT NULL,
	BLOCK_ID	NUMBER(20) NOT NULL,				--could be template ID or auto generated AND/OR block
	BLOCK_TYPE	VARCHAR2(32) NOT NULL,			-- AND/OR/EVENT/TERMINAL
	XPOS		NUMBER(20) NOT NULL,
	YPOS		NUMBER(20) NOT NULL,
    CONSTRAINT PK_SP_BLOCK_ID PRIMARY KEY(ID) USING INDEX  TABLESPACE TS_RANGER,
--    CONSTRAINT FK_SP_BLOCK_BLOCK_TEMPLATE_ID  FOREIGN KEY(TEMPLATE_ID) REFERENCES RULES(ID)
    CONSTRAINT FK_SP_BLOCK_TEMPLATE_ID  FOREIGN KEY(TEMPLATE_ID) REFERENCES RULES(ID)
) TABLESPACE TS_RANGER;

CREATE TABLE SP_CONNECTIONS (
	ID				NUMBER(20) NOT NULL,
	TEMPLATE_ID		NUMBER(20) NOT NULL,
	SOURCE_BLOCK	NUMBER(20) NOT NULL,
	TARGET_BLOCK	NUMBER(20) NOT NULL,
    CONSTRAINT PK_SP_CONN_ID PRIMARY KEY(ID) USING INDEX  TABLESPACE TS_RANGER,
--    CONSTRAINT UK_SP_CONN_ID UNIQUE (SOURCE_BLOCK, TARGET_BLOCK),
    CONSTRAINT FK_SP_CONN_PATTERN_ID  FOREIGN KEY(TEMPLATE_ID) REFERENCES SP_PATTERNS(ID)
) TABLESPACE TS_RANGER;

CREATE SEQUENCE SP_BLOCKS_SEQ INCREMENT BY 1 START WITH 1 NOMAXVALUE MINVALUE 1 NOCYCLE CACHE 20 ORDER ;
CREATE SEQUENCE SP_CONNECTIONS_SEQ INCREMENT BY 1 START WITH 1 NOMAXVALUE MINVALUE 1 NOCYCLE CACHE 20 ORDER ;

CREATE TABLE SMART_PATTERN_ALERT_DATA
(
 ALERT_ID				NUMBER(20,0)	NOT NULL, --remove
 BLOCK_ID				NUMBER(20,0) 	NOT NULL,
 LAST_CDR_TIME			DATE 			NOT NULL,
 FIRST_CDR_TIME			DATE 			NOT NULL,
 SCORE					NUMBER(20,0) 	NOT NULL, --remove
 REFERENCE_ID			NUMBER(20,0) 	NOT NULL, --remove
 AGGREGATION_TYPE		NUMBER(20) 		NOT NULL,
 AGGREGATION_VALUE		VARCHAR2(40) 	NOT NULL,
 SMART_PATTERN_ID		NUMBER(20,0) 	NOT NULL,
 MIN_CDR_ID				NUMBER(20,0) 	NOT NULL, --remove
 MAX_CDR_ID				NUMBER(20,0) 	NOT NULL, --remove 
 INPUT_RELATION_VALUE	VARCHAR2(256),
 OUTPUT_RELATION_VALUE	VARCHAR2(256)) TABLESPACE TS_RANGER;

CREATE TABLE SMART_PATTERN_BLOCK_RECORDS (
	BLOCK_ID	 		NUMBER(20,0) NOT NULL,
	RECORD_ID 			NUMBER(20,0) NOT NULL,
	RECORD_VALUE		NUMBER(16,6) NOT NULL,
	RECORD_CATEGORY 	NUMBER(20,0) NOT NULL,
	RECORD_TIME			DATE 		 NOT NULL,
	CONSTRAINT PK_SP_BR_BL_ID_REC_ID PRIMARY KEY (BLOCK_ID, RECORD_ID, RECORD_CATEGORY) USING INDEX  TABLESPACE TS_RANGER) TABLESPACE TS_RANGER ;
quit ;
