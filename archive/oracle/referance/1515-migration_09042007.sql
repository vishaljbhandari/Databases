spool migration_09042007.log

insert into expandable_field_maps(id, name, source_view_id, source_key, dest_view_id, dest_key, is_new_view, dest_key_type,
	category) values (1543,'Alarm Billing Number Summary Info',10,'ID',28,'ALARM_ID',1,2,'RECORD_VIEW');

insert into expandable_field_maps(id, name, source_view_id, source_key, dest_view_id, dest_key, is_new_view, dest_key_type,
	category) values (1544,'Alarm Billing Number Summary Info',10,'ID',28,'ALARM_ID',1,3,'RECORD_VIEW');

CREATE OR REPLACE VIEW BILLING_NUMBER_SUMMARY AS (
	SELECT ALARM_ID, BILLING_NUMBER, COUNT(CDR_ID) AS CDR_COUNT, SUM(DURATION) AS TOTAL_DURATION, SUM(VALUE) AS TOTAL_VALUE 
		FROM (
			SELECT  AL.ALARM_ID, C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER ,C.ID AS CDR_ID, C.DURATION,	C.VALUE
					FROM ALERTS  AL, CDR C 
					WHERE C.ID IN (	SELECT 	DISTINCT CDR_ID 
										FROM ALERT_CDR 
										WHERE ALERT_ID = AL.ID AND RECORD_CATEGORY= 1 ) 
					AND AL.AGGREGATION_TYPE = 1003 
					AND C.OP_CALLING_CARD_NUMBER = AL.AGGREGATION_VALUE  
			UNION
			SELECT  AL.ALARM_ID, C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER ,C.ID AS CDR_ID, C.DURATION,	C.VALUE
					FROM ALERTS  AL, CDR C 
					WHERE C.ID IN (	SELECT 	DISTINCT CDR_ID 
										FROM ALERT_CDR 
										WHERE ALERT_ID = AL.ID AND RECORD_CATEGORY= 1 ) 
					AND AL.AGGREGATION_TYPE = 1004 
					AND to_char(C.OP_ACCOUNT_NUMBER) = AL.AGGREGATION_VALUE  
			UNION
			SELECT  AL.ALARM_ID, C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER ,C.ID AS CDR_ID, C.DURATION,	C.VALUE
					FROM ALERTS  AL, CDR C 
					WHERE C.ID IN (	SELECT 	DISTINCT CDR_ID 
										FROM ALERT_CDR 
										WHERE ALERT_ID = AL.ID AND RECORD_CATEGORY= 1 ) 
					AND AL.AGGREGATION_TYPE = 1000 
					AND C.CALLER_NUMBER = AL.AGGREGATION_VALUE  
			UNION
			SELECT  AL.ALARM_ID, C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER ,C.ID AS CDR_ID, C.DURATION,	C.VALUE
					FROM ALERTS  AL, CDR C 
					WHERE C.ID IN (	SELECT 	DISTINCT CDR_ID 
										FROM ALERT_CDR 
										WHERE ALERT_ID = AL.ID AND RECORD_CATEGORY= 1 ) 
					AND AL.AGGREGATION_TYPE = 1001 
					AND C.CALLED_NUMBER = AL.AGGREGATION_VALUE  
			UNION
			SELECT  AL.ALARM_ID, C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER ,C.ID AS CDR_ID, C.DURATION,	C.VALUE
					FROM ALERTS  AL, CDR C 
					WHERE C.ID IN (	SELECT 	DISTINCT CDR_ID 
										FROM ALERT_CDR 
										WHERE ALERT_ID = AL.ID AND RECORD_CATEGORY= 1 ) 
					AND AL.AGGREGATION_TYPE = 1002 
					AND C.OP_BILLED_PHONE_NUMBER = AL.AGGREGATION_VALUE  
			UNION
			SELECT  AL.ALARM_ID, C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER ,C.ID AS CDR_ID, C.DURATION,	C.VALUE
					FROM ALERTS  AL, CDR C 
					WHERE C.ID IN (	SELECT 	DISTINCT CDR_ID 
										FROM ALERT_CDR 
										WHERE ALERT_ID = AL.ID AND RECORD_CATEGORY= 1 ) 
					AND AL.AGGREGATION_TYPE = 2 
					AND C.PHONE_NUMBER = AL.AGGREGATION_VALUE  
				) GROUP BY ALARM_ID, BILLING_NUMBER
);

CREATE OR REPLACE VIEW BILLING_NUMBER_ALERT_VIEW AS (
	SELECT  DISTINCT AL.* , C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER
		FROM ALERTS AL, CDR C 
		WHERE C.CALLER_NUMBER = AL.AGGREGATION_VALUE 
		AND AL.AGGREGATION_TYPE = 1000 
		AND C.ID IN ( SELECT DISTINCT CDR_ID FROM ALERT_CDR WHERE ALERT_ID = AL.ID )
		AND AL.ALARM_ID IN (SELECT ID FROM ALARMS WHERE STATUS NOT IN ( 2, 4, 8))
	UNION
	SELECT  DISTINCT AL.* , C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER
		FROM ALERTS AL, CDR C 
		WHERE C.CALLED_NUMBER = AL.AGGREGATION_VALUE 
		AND AL.AGGREGATION_TYPE = 1001 
		AND C.ID IN ( SELECT DISTINCT CDR_ID FROM ALERT_CDR WHERE ALERT_ID = AL.ID )
		AND AL.ALARM_ID IN (SELECT ID FROM ALARMS WHERE STATUS NOT IN ( 2, 4, 8))
	UNION
	SELECT  DISTINCT AL.* , C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER
		FROM ALERTS AL, CDR C 
		WHERE C.OP_BILLED_PHONE_NUMBER = AL.AGGREGATION_VALUE 
		AND AL.AGGREGATION_TYPE = 1002 
		AND C.ID IN ( SELECT DISTINCT CDR_ID FROM ALERT_CDR WHERE ALERT_ID = AL.ID )
		AND AL.ALARM_ID IN (SELECT ID FROM ALARMS WHERE STATUS NOT IN ( 2, 4, 8))
	UNION
	SELECT  DISTINCT AL.* , C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER
		FROM ALERTS AL, CDR C 
		WHERE C.PHONE_NUMBER = AL.AGGREGATION_VALUE 
		AND AL.AGGREGATION_TYPE = 2 
		AND C.ID IN ( SELECT DISTINCT CDR_ID FROM ALERT_CDR WHERE ALERT_ID = AL.ID )
		AND AL.ALARM_ID IN (SELECT ID FROM ALARMS WHERE STATUS NOT IN ( 2, 4, 8))
	UNION
	SELECT  DISTINCT AL.* , C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER
		FROM ALERTS AL, CDR C 
		WHERE C.OP_CALLING_CARD_NUMBER = AL.AGGREGATION_VALUE 
		AND AL.AGGREGATION_TYPE = 1003 
		AND C.ID IN ( SELECT DISTINCT CDR_ID FROM ALERT_CDR WHERE ALERT_ID = AL.ID )
		AND AL.ALARM_ID IN (SELECT ID FROM ALARMS WHERE STATUS NOT IN ( 2, 4, 8))
	UNION
	SELECT  DISTINCT AL.* , C.OP_BILLED_PHONE_NUMBER AS BILLING_NUMBER
		FROM ALERTS AL, CDR C 
		WHERE to_char(C.OP_ACCOUNT_NUMBER) = AL.AGGREGATION_VALUE 
		AND AL.AGGREGATION_TYPE = 1004 
		AND C.ID IN ( SELECT DISTINCT CDR_ID FROM ALERT_CDR WHERE ALERT_ID = AL.ID )
		AND AL.ALARM_ID IN (SELECT ID FROM ALARMS WHERE STATUS NOT IN ( 2, 4, 8))
);

--Tasks for Billing Summary info
insert into task_additional_actions values ( task_additional_actions_seq.nextval, 17, '/record_view/list/28') ;
insert into task_additional_actions values ( task_additional_actions_seq.nextval, 20, '/record_view/list/28') ;
insert into task_additional_actions values ( task_additional_actions_seq.nextval, 22, '/record_view/list/28') ;

insert into task_additional_actions values ( task_additional_actions_seq.nextval, 17, '/record_view/list/29') ;
insert into task_additional_actions values ( task_additional_actions_seq.nextval, 20, '/record_view/list/29') ;
insert into task_additional_actions values ( task_additional_actions_seq.nextval, 22, '/record_view/list/29') ;

spool off ;
commit ;
exit ;
