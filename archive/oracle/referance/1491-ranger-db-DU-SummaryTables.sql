SET FEEDBACK OFF
SPOOL ranger-db-DU-SummaryTables.log

DROP SEQUENCE DU_PGW_DATA_ID ;
DROP SEQUENCE ARCH_DU_PGW_DATA_ID ;

DROP INDEX IX_PN_IMEI_IMSI ;
DROP INDEX IX_REPORTS_RET_UID_DATE ;
DROP INDEX IX_ANA_PERF_UID ;
DROP INDEX IX_PGW_DATA_TS_CN_ED_AN ;
DROP INDEX IX_PGW_DATA_MSI ;
DROP INDEX IX_AR_PGW_DATA_TS_CN_ED_AN ;
DROP INDEX IX_AR_PGW_DATA_MSI ;
DROP INDEX IX_PGW_SUM_TS ;

DROP TABLE DU_DAILY_CDR_SUMMARY ;
DROP TABLE TEMP_DU_INTERNATIONAL_CDRS ;
DROP TABLE TEMP_DU_INROAMER_CDRS ;
DROP TABLE TEMP_DU_PROCESSED_FILES ;
DROP TABLE DU_INTERNATIONAL_CDR_SUMMARY ;
DROP TABLE DU_INROAMER_CDR_SUMMARY ;
DROP TABLE DU_FILE_NAME_SEQUANCE_REGEX ;
DROP TABLE DU_OLDEST_FILE_PROCESSED ;
DROP TABLE DU_SOURCE_DESCRIPTION ;
DROP TABLE DU_DATA_FILE_PROCESSED ;
DROP TABLE DU_TERMINAL_INFORMATION ;
DROP TABLE TEMP_DU_TERMINAL_INFORMATION ;
DROP TABLE DU_TERMINAL_USAGE_INFO ;
DROP TABLE TEMP_DU_TERMINAL_USAGE_INFO ;
DROP TABLE DU_REPORTS_RETRIEVED_SUMMARY ;
DROP TABLE DU_SERVER_STATUS_SUMMARY ;
DROP TABLE DU_REPORT_NAME_MAP ;
DROP TABLE DU_PGW_DATA ;
DROP TABLE ARCHIVED_DU_PGW_DATA ;
DROP TABLE DU_PGW_SUMMARY ;
DROP TABLE DU_FMS_LOG_SUMMARY ;
DROP TABLE DU_ALARM_STATE_SUMMARY ;
DROP TABLE DU_ALARM_DETECTION_SUMMARY ;
DROP TABLE DU_ALARM_RESOLUTION_SUMMARY ;
DROP TABLE DU_EVENTINSTANCE_SUMMARY ;
DROP TABLE DU_ANALYST_PERFORMANCE_SUMMARY ;
DROP TABLE DU_RSP_CODES ;
DROP TABLE DU_HUR_SUMMARY ;
DROP TABLE DU_HUR_SUMMARY_TEMP ;
DROP TABLE PARTICIPATING_INROAMERS ;

CREATE TABLE DU_DAILY_CDR_SUMMARY
(
 	TIME_STAMP			DATE,
	PRODUCT_TYPE		NUMBER (1),
	SERVICE_TYPE		NUMBER (1),
	CALL_TYPE			NUMBER (1),
	TYPE_OF_CALL		VARCHAR2 (10),
	TOTAL_COUNT			NUMBER (10),
	TOTAL_DURATION		NUMBER (26,6),
	TOTAL_VALUE			NUMBER (16,4),
	STREAM_INDICATOR	VARCHAR2(8)
) ;

CREATE TABLE DU_INTERNATIONAL_CDR_SUMMARY
(
	TIME_STAMP 			DATE,
	COUNTRY_CODE 		VARCHAR2 (20),
	CDR_TYPE 			NUMBER (1),
	SERVICE_TYPE 		NUMBER (1),
	TYPE_OF_CALL 		VARCHAR2 (10),
	TOTAL_COUNT 		NUMBER (10),
	TOTAL_DURATION 		NUMBER (20),
	TOTAL_VALUE 		NUMBER (16,4)
) ;

CREATE TABLE TEMP_DU_INTERNATIONAL_CDRS
(
	TIME_STAMP			DATE,
	COUNTRY_CODE		VARCHAR2 (20),
	PRODUCT_TYPE		NUMBER (1),
	SERVICE_TYPE		NUMBER (1),
	TYPE_OF_CALL		VARCHAR2 (10),
	VALUE				NUMBER (16,4),
	DURATION			NUMBER (20)
) ;
	
CREATE TABLE DU_INROAMER_CDR_SUMMARY
(
	TIME_STAMP 			DATE,
	COUNTRY_CODE 		VARCHAR2 (20),
	NETWORK_CODE		VARCHAR2 (256),
	TOTAL_COUNT 		NUMBER (10),
	TOTAL_DURATION 		NUMBER (26,6),
	TOTAL_VALUE 		NUMBER (16,4),
	DISTINCT_IMSI_COUNT	NUMBER(10),
	STREAM_INDICATOR	VARCHAR2(8)
) ;

CREATE TABLE TEMP_DU_INROAMER_CDRS
(
	TIME_STAMP			DATE,
	COUNTRY_CODE		VARCHAR2 (20),
	NETWORK_CODE		VARCHAR2 (256),
	VALUE				NUMBER (16,4),
	DURATION			NUMBER (26,6),
	IMSI				VARCHAR2(40),
	STREAM_INDICATOR	VARCHAR2(8)
) ;

CREATE TABLE TEMP_DU_PROCESSED_FILES
(
	FILE_NAME       VARCHAR2(256),
	FILE_SIZE       NUMBER(10),
	FILE_TIMESTAMP  DATE,
	SOURCE          NUMBER(10),
	SEQUANCE_NUMBER NUMBER(20)
) ;

CREATE TABLE DU_FILE_NAME_SEQUANCE_REGEX
(
	DS_ID           NUMBER (10),
	REGEX           VARCHAR2(256),
	DESCRIPTION     VARCHAR2(256),
	CONSTRAINT PK_PR_DS_ID PRIMARY KEY (DS_ID)
) ;

CREATE TABLE DU_OLDEST_FILE_PROCESSED
(
	PROCESS_DATE    DATE,
	DS_ID           NUMBER (10),
	FILE_NAME       VARCHAR2(256),
	SEQUANCE_NUMBER NUMBER (20),
	FILE_TIMESTAMP  DATE,
	CONSTRAINT PK_PR_DATE_DS_ID PRIMARY KEY (PROCESS_DATE, DS_ID)
) ;

CREATE TABLE DU_SOURCE_DESCRIPTION
(
	SOURCE			NUMBER(10),
	DESCRIPTION		VARCHAR2(128)
) ;

CREATE TABLE DU_DATA_FILE_PROCESSED
(
	FILE_TIMESTAMP	DATE,
	FILE_NAME		VARCHAR2(256),
	FILE_SIZE		NUMBER(10),
	SOURCE			NUMBER(10)
) ;

CREATE TABLE DU_TERMINAL_INFORMATION
(
 	TAC_CODE		VARCHAR2(20),
	MANUFACTURER	VARCHAR2(256),
	MODEL_NUMBER	VARCHAR2(256),
	CONSTRAINT PK_TAC_CODE PRIMARY KEY (TAC_CODE)
) ;

CREATE TABLE TEMP_DU_TERMINAL_INFORMATION
(
 	TAC_CODE		VARCHAR2(20) NOT NULL,
	MANUFACTURER	VARCHAR2(256),
	MODEL_NUMBER	VARCHAR2(256)
) ;

CREATE TABLE DU_TERMINAL_USAGE_INFO
(
	PHONE_NUMBER		VARCHAR2(40),
	IMSI 		   		VARCHAR2(20),
	IMEI				VARCHAR2(24),
	TAC_CODE			VARCHAR2(20),
	DISTINCT_DAYS_USED	NUMBER(10),
	FIRST_DATE_OF_USAGE DATE,
	LAST_DATE_OF_USAGE  DATE,
	DAYS_USED			VARCHAR2(1024),
	CONSTRAINT PK_PH_NU_IMSI_TAC PRIMARY KEY (PHONE_NUMBER,IMSI,TAC_CODE)
) ;

CREATE INDEX IX_PN_IMEI_IMSI ON DU_TERMINAL_USAGE_INFO(PHONE_NUMBER, IMEI, IMSI) ;

CREATE TABLE TEMP_DU_TERMINAL_USAGE_INFO
(
	TIME_STAMP			DATE,
	IMEI				VARCHAR2(40) NOT NULL,
	IMSI				VARCHAR2(40) NOT NULL,
	PHONE_NUMBER		VARCHAR2(40) NOT NULL
) ;
	
CREATE TABLE DU_SERVER_STATUS_SUMMARY
(
 	DATE_TIME			DATE,
	FMS_LOG_ID			NUMBER,
	FMS_LOG_TABLE_ID	NUMBER
) ;

CREATE  TABLE DU_REPORTS_RETRIEVED_SUMMARY
(
    DATE_TIME				DATE,
	USER_ID					VARCHAR2(15),
	AUDIT_TRAILS_TABLE_ID	NUMBER
);


CREATE INDEX IX_REPORTS_RET_UID_DATE ON DU_REPORTS_RETRIEVED_SUMMARY(USER_ID,DATE_TIME) ;

CREATE TABLE DU_REPORT_NAME_MAP
(
 	JASPER				VARCHAR2(256),
	REPORTNAME			VARCHAR2(256)
);

CREATE TABLE DU_FMS_LOG_SUMMARY (
   	ANALYST_ID  	varchar2(40),
   	LOGIN_TIME 		date,
   	LOGOUT_TIME 	date,
   	CONSTRAINT CK_AN_LGIN UNIQUE(ANALYST_ID,LOGIN_TIME),
   	CONSTRAINT CK_AN_LGOUT UNIQUE(ANALYST_ID,LOGOUT_TIME)
);

CREATE TABLE DU_ALARM_STATE_SUMMARY(
    SUMMARY_DATE DATE,
    ALT NUMBER(2),
    AVL NUMBER(2),
    FRD NUMBER(2),
    INV NUMBER(2),
    NFRD NUMBER(2),
    PEN NUMBER(2),
    NEW NUMBER(2)
) ;

CREATE TABLE DU_ALARM_DETECTION_SUMMARY
(
    EVENT_NAME          VARCHAR2(256),
    ALARM_CREATED_DATE  DATE,
    DETECTION_TIME      NUMBER(16,12)
) ;

CREATE TABLE DU_ALARM_RESOLUTION_SUMMARY
(
    USER_ID                 VARCHAR2(40),
    ALARM_CREATED_DATE      DATE,
    RESOLUTION_TIME         NUMBER(16,6)
) ;


CREATE TABLE DU_EVENTINSTANCE_SUMMARY
(
	USER_ID			VARCHAR2(16),
	ALARM_ID		NUMBER,
	STATUS_CHANGE	VARCHAR2(256),
	LOG_TIME		DATE,
	PHONE_NUMBER	VARCHAR2(40)
);

CREATE TABLE DU_ANALYST_PERFORMANCE_SUMMARY
(
	USER_ID 			VARCHAR2(15),
	LOG_TIME 			DATE,
	STATUS_CHANGE 		VARCHAR2(256),
	GROUPS 				VARCHAR2(256),
	PRODUCT_TYPE 		NUMBER,
	SUBSCRIPTION_TYPE 	VARCHAR2(40),
	ALARM_ID 			NUMBER
) ;

CREATE INDEX IX_ANA_PERF_UID ON DU_ANALYST_PERFORMANCE_SUMMARY (USER_ID) ;

CREATE TABLE DU_RSP_CODES
(
    RSP_CODE		VARCHAR2(256),
    DESCRIPTION			VARCHAR2(256)
) ;

CREATE SEQUENCE DU_PGW_DATA_ID INCREMENT BY 1 START WITH 1024 NOMAXVALUE MINVALUE 1 NOCYCLE CACHE 20 ORDER ;
CREATE TABLE DU_PGW_DATA
(
	ID						NUMBER(20)		NOT NULL,
	MSISDN					VARCHAR2(40)	NOT NULL,
	TIMESTAMP				DATE			NOT NULL,
	CARD_NO					VARCHAR2(16)	NOT NULL,
	ACCOUNT_NAME			VARCHAR2(40)	NOT NULL,
	VALUE					NUMBER(16,6)	NOT NULL,
	START_DATE				VARCHAR2(8),
	EXPIRY_DATE				VARCHAR2(8)		NOT NULL,
	CARD_HOLDER_NAME		VARCHAR2(64)	NOT NULL,
	CARD_ACCEPTOR_ID_CODE	NUMBER(20),
	TRANSACTION_ID			NUMBER(20)		NOT NULL,
	TRANSACTION_TYPE		NUMBER(20),
	STATUS					VARCHAR2(40),
	PAY_CHANNEL				VARCHAR2(40),
	FIRST_NAME				VARCHAR2(80),
	LAST_NAME				VARCHAR2(80),
	IP_ADDRESS				VARCHAR2(256),
	RSPCODE					VARCHAR2(5)		NOT NULL,
	DEST_MSISDN				VARCHAR2(40),
	RESPONSE_CODE			VARCHAR2(5),
	CARD_TYPE				VARCHAR2(20),
	ID_NUMBER				VARCHAR2(20),
	ISSUE					VARCHAR2(20),
	SUBSCRIBER_ID			NUMBER(20,0),
	NETWORK_ID				NUMBER(20,0),
	DAY_OF_YEAR				NUMBER(20,0) DEFAULT 0
);

CREATE INDEX IX_PGW_DATA_TS_CN_ED_AN ON DU_PGW_DATA(TIMESTAMP,CARD_NO,EXPIRY_DATE,ACCOUNT_NAME) ;
CREATE INDEX IX_PGW_DATA_MSI ON DU_PGW_DATA(MSISDN) ;

CREATE SEQUENCE ARCH_DU_PGW_DATA_ID INCREMENT BY 1 START WITH 1024 NOMAXVALUE MINVALUE 1 NOCYCLE CACHE 20 ORDER ;
CREATE TABLE ARCHIVED_DU_PGW_DATA
(
	ID						NUMBER(20)		NOT NULL,
	MSISDN					VARCHAR2(40)	NOT NULL,
	TIMESTAMP				DATE			NOT NULL,
	CARD_NO					VARCHAR2(16)	NOT NULL,
	ACCOUNT_NAME			VARCHAR2(40)	NOT NULL,
	VALUE					NUMBER(16,6)	NOT NULL,
	START_DATE				VARCHAR2(8),
	EXPIRY_DATE				VARCHAR2(8)		NOT NULL,
	CARD_HOLDER_NAME		VARCHAR2(64)	NOT NULL,
	CARD_ACCEPTOR_ID_CODE	VARCHAR2(20),
	TRANSACTION_ID			VARCHAR2(20),
	TRANSACTION_TYPE		VARCHAR2(20),
	STATUS					VARCHAR2(40),
	PAY_CHANNEL				VARCHAR2(40),
	FIRST_NAME				VARCHAR2(80),
	LAST_NAME				VARCHAR2(80),
	IP_ADDRESS				VARCHAR2(256),
	RSPCODE					VARCHAR2(5),
	DEST_MSISDN				VARCHAR2(40),
	RESPONSE_CODE			VARCHAR2(5),
	CARD_TYPE				VARCHAR2(20),
	ID_NUMBER				VARCHAR2(20),
	ISSUE					VARCHAR2(20),
	SUBSCRIBER_ID			NUMBER(20,0),
	NETWORK_ID				NUMBER(20,0),
	DAY_OF_YEAR				NUMBER(20,0) DEFAULT 0
);

CREATE INDEX IX_AR_PGW_DATA_TS_CN_ED_AN ON ARCHIVED_DU_PGW_DATA(TIMESTAMP,CARD_NO,EXPIRY_DATE,ACCOUNT_NAME) ;
CREATE INDEX IX_AR_PGW_DATA_MSI ON ARCHIVED_DU_PGW_DATA(MSISDN) ;

CREATE TABLE DU_PGW_SUMMARY
(
	TIME_STAMP			DATE NOT NULL,
	CARD_NO				VARCHAR2(16) NOT NULL,
	ACCOUNT_NAME		VARCHAR2(40) NOT NULL,
	EXPIRY_DATE			VARCHAR2(8) NOT NULL,
	CARD_HOLDER_NAME	VARCHAR2(64) NOT NULL,
	RECORD_COUNT		NUMBER NOT NULL,
	VALUE				NUMBER(16,6) NOT NULL
 );

CREATE INDEX IX_PGW_SUM_TS ON DU_PGW_SUMMARY (TIME_STAMP) ;

CREATE OR REPLACE FUNCTION GET_DATE_DIFF (DATE_FIELD DATE, DAYS NUMBER) RETURN DATE IS
DATE_DIFF		NUMBER := 0 ;
BEGIN
	DATE_DIFF := TO_CHAR(DATE_FIELD, 'ddd') - DAYS ;
	IF DATE_DIFF > 0 THEN
		RETURN DATE_FIELD - (TO_CHAR(DATE_FIELD, 'ddd') - DAYS) ;
	ELSIF DATE_DIFF = 0 THEN
		RETURN DATE_FIELD ;
	ELSE
		RETURN DATE_FIELD - TO_CHAR(DATE_FIELD - TO_CHAR(DATE_FIELD, 'ddd') - DAYS + TO_CHAR(DATE_FIELD, 'ddd'), 'ddd') ;
	END IF ;
END GET_DATE_DIFF ;
/

CREATE OR REPLACE FUNCTION GET_DURATION_IN_DD_HHHMM (DURATION NUMBER) RETURN VARCHAR2 IS
F_HHH					NUMBER(3) := 0 ;
F_MM					NUMBER(2) := 0 ;
F_SS					NUMBER(2) := 0 ;
Temp					NUMBER(10) := 0 ;
Ret						VARCHAR2(20) := NULL ;
BEGIN
	Ret 	:= TRUNC(DURATION) ;
	Temp 	:= (DURATION - TRUNC(DURATION)) * 86400 ;
	F_HHH 	:= FLOOR(Temp / 3600) ;
	Temp 	:= Temp - (F_HHH * 3600) ;
	F_MM  	:= FLOOR(Temp / 60) ;
	Temp 	:= Temp - (F_MM * 60) ;
	F_SS  	:= Temp ; 
	Ret 	:= Ret || '  ' || LPAD (F_HHH, 3, 0) || ':' || LPAD (F_MM, 2, 0) || ':' || LPAD (F_SS, 2, 0) ;
	RETURN Ret ;
END GET_DURATION_IN_DD_HHHMM ;
/
INSERT INTO DU_SOURCE_DESCRIPTION SELECT ID, NAME FROM RIP_DATASOURCE_INFO ;
INSERT INTO DU_SOURCE_DESCRIPTION VALUES (-10, 'dutapincdrds') ;
INSERT INTO DU_SOURCE_DESCRIPTION VALUES (20, 'ss7ds') ;


CREATE TABLE DU_HUR_SUMMARY
(
	IMSI_NUMBER         VARCHAR2(40),
	TIME_STAMP          DATE,
	DESTINATION         VARCHAR2(40),
	ROAMER_PARTNER      VARCHAR2(40),
	DURATION_VOLUME     NUMBER(20),
	VALUE               NUMBER(16,6),
	GPRS_DURATION		NUMBER(20),
	STREAM_TYPE         VARCHAR2(10)
) ;

CREATE TABLE DU_HUR_SUMMARY_TEMP
(
	IMSI_NUMBER         VARCHAR2(40),
	TIME_STAMP          DATE,
	DESTINATION         VARCHAR2(40),
	ROAMER_PARTNER      VARCHAR2(40),
	DURATION_VOLUME     NUMBER(20),
	VALUE               NUMBER(16,6),
	GPRS_DURATION		NUMBER(20),
	STREAM_TYPE         VARCHAR2(10)
) ;

CREATE TABLE PARTICIPATING_INROAMERS
(
	ROAMER_PARTNER	VARCHAR2(40),
	IMSI_NUMBER		VARCHAR2(40),
	TOTAL_VALUE		NUMBER,
	METRIX			NUMBER,
	START_TIME		DATE,
	END_TIME		DATE,
	CALL_COUNT		NUMBER,
	GPRS_DURATION	NUMBER(20),
	STREAM_TYPE		VARCHAR2(10)
) ;
	
SPOOL OFF ;
QUIT;
